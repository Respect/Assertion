#!/usr/bin/env bash

set -euo pipefail

declare -r IFS=$'\n'
declare -r DIRECTORY=$(dirname "${BASH_SOURCE}")
declare -r ALLOW_LIST="${DIRECTORY}/allow_list"
declare -r ORIGINAL_VALIDATOR="${DIRECTORY}/../vendor/respect/validation/library/ChainedValidator.php"
declare -r ORIGINAL_ASSERT="${DIRECTORY}/../src/AssertMixin.php"
declare -r ORIGINAL_CHAIN_ASSERT="${DIRECTORY}/../src/ChainAssertMixin.php"


declare -r TRANSFORMED_VALIDATOR="${DIRECTORY}/../src/ChainedValidator.php"
declare -r ALL_RULES=$(mktemp)
declare -r CANONICAL_RULES=$(mktemp)
declare -r SPECIAL_RULES=$(mktemp)
declare -r TEMPORARY_ASSERT="${DIRECTORY}/../src/AssertTmp.php"
declare -r TEMPORARY_CHAIN_ASSERT="${DIRECTORY}/../src/ChainAssertTmp.php"

exclude-function()
{
  grep --invert-match "public function ${1}("
}

add-prefixes()
{
  local prefix="${1}"
  local rules="${2}"
  local extra_parameter="${3:-}"

  if [ ! -z "${extra_parameter}" ]; then
      extra_parameter="${extra_parameter}, "
  fi

  sed --regexp-extended "s/public function ([^(]+)\(/public function ${prefix}\u\1(${extra_parameter}/g" "${rules}" |
      sed "s,${prefix}Equals,${prefix},g"
}

add-function()
{
  local name="${1}"
  local extra_parameter="${2:-}"

  if [ ! -z "${extra_parameter}" ]; then
      extra_parameter="${extra_parameter}, "
  fi

  echo "public function ${name}(${extra_parameter}Throwable|string|null \$description = null): self;"
}

echo "- Parsing all rules"
cp "${ORIGINAL_VALIDATOR}" "${TRANSFORMED_VALIDATOR}"
vendor/bin/phpcbf -q "${TRANSFORMED_VALIDATOR}" || true
{
  sed -n "/^{/,/^}/p" "${TRANSFORMED_VALIDATOR}" |
    tr --delete '{}' |
    sed --regexp-extended ':a;N;$!ba;s/\n+( +)//g' |
    sed "s,* @param,\n    * @param,g" |
    sed "s,*/,\n    */\n    ,g" |
    sed "s,\;,;\n\n    ,g" |
    sed --regexp-extended 's,string \.{3}(\$[a-zA-Z0-9_]+),string \1 = "",g' |
    sed --regexp-extended 's,([a-zA-Z0-9_]+) \.{3}(\$[a-zA-Z0-9_]+),?\1 \2 = null,g' |
    grep --invert-match "Validatable" |
    exclude-function "alwaysInvalid" |
    exclude-function "alwaysValid" |
    exclude-function "key" |
    exclude-function "keySet" |
    exclude-function "keyValue" |
    exclude-function "length" |
    exclude-function "max" |
    exclude-function "min" |
    exclude-function "sf" |
    exclude-function "zend" |
    sed "s/): .\+/, Throwable|string|null \$description = null): self\;/g" |
    sed "s/(, /(/g" > "${CANONICAL_RULES}"

  while read -r rule_name; do
    grep "public function ${rule_name}(" "${CANONICAL_RULES}" >> "${SPECIAL_RULES}" || continue
  done < "${ALLOW_LIST}"

  # original rules
  cat "${CANONICAL_RULES}"

  add-prefixes "all" "${CANONICAL_RULES}"
  add-prefixes "allNot" "${CANONICAL_RULES}"
  add-prefixes "key" "${CANONICAL_RULES}" "mixed \$key"
  add-function "keyPresent" "mixed \$key"
  add-prefixes "keyNot" "${CANONICAL_RULES}" "mixed \$key"
  add-function "keyNotPresent" "mixed \$key"
  add-prefixes "property" "${CANONICAL_RULES}" "string \$property"
  add-function "propertyPresent" "string \$property"
  add-prefixes "propertyNot" "${CANONICAL_RULES}" "string \$property"
  add-function "propertyNotPresent" "string \$property"
  add-prefixes "not" "${CANONICAL_RULES}"
  add-prefixes "nullOr" "${CANONICAL_RULES}"
  add-prefixes "nullOrNot" "${CANONICAL_RULES}"
  add-prefixes "length" "${SPECIAL_RULES}"
  add-prefixes "max" "${SPECIAL_RULES}"
  add-prefixes "min" "${SPECIAL_RULES}"
} > "${ALL_RULES}"

rm "${TRANSFORMED_VALIDATOR}"

echo "- Updating ${ORIGINAL_ASSERT}"
{
  sed --silent "/<?/,/^{/p" "${ORIGINAL_ASSERT}"
  sed --regexp-extended "s/public function ([^(]+)\(/public static function \1(mixed \$input, /g" "${ALL_RULES}" |
    sed "s/, )/)/g" |
    sed "s,self,void,g"
  echo "}"
} > "${TEMPORARY_ASSERT}"

vendor/bin/phpcbf -q "${TEMPORARY_ASSERT}" || true
mv "${TEMPORARY_ASSERT}" "${ORIGINAL_ASSERT}"

echo "- Updating ${ORIGINAL_CHAIN_ASSERT}"
{
  sed --silent "/<?/,/^{/p" "${ORIGINAL_CHAIN_ASSERT}"
  cat "${ALL_RULES}"
  echo "}"
} > "${TEMPORARY_CHAIN_ASSERT}"

vendor/bin/phpcbf -q "${TEMPORARY_CHAIN_ASSERT}" || true
mv "${TEMPORARY_CHAIN_ASSERT}" "${ORIGINAL_CHAIN_ASSERT}"

echo "Finished!"
